<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Boarding Pass ‚Äî Flight Plan</title>
  <meta name="theme-color" content="#F6F7FB"/>

  <style>
    :root{
      /* Light palette */
      --bg:#F6F7FB;
      --fg:rgba(10,14,24,.92);
      --muted:rgba(10,14,24,.62);
      --line:rgba(10,14,24,.12);
      --card:rgba(255,255,255,.70);
      --card2:rgba(255,255,255,.50);
      --shadow: 0 20px 70px rgba(16,24,40,.12);

      /* One accent family (modern blue) */
      --accent:#2563EB;
      --accent2:#60A5FA;

      --ok:#16A34A;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--fg);
      background:
        radial-gradient(900px 600px at 15% 15%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(96,165,250,.10), transparent 60%),
        radial-gradient(900px 600px at 55% 95%, rgba(37,99,235,.07), transparent 60%),
        var(--bg);
      overflow:auto;
    }

    /* subtle mesh */
    .mesh{position:fixed; inset:-20%; filter: blur(70px); opacity:.35; pointer-events:none;}
    .blob{position:absolute; width:44vmax; height:44vmax; border-radius:999px;
      background: linear-gradient(135deg, rgba(37,99,235,.30), rgba(96,165,250,.18));
      animation: drift 18s ease-in-out infinite;
    }
    .blob:nth-child(2){width:38vmax;height:38vmax; left:56%; top:10%;
      background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(37,99,235,.12));
      animation-duration: 22s; opacity:.75;
    }
    .blob:nth-child(3){width:34vmax;height:34vmax; left:8%; top:58%;
      background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(96,165,250,.12));
      animation-duration: 26s; opacity:.6;
    }
    @keyframes drift{
      0%{transform:translate3d(-3%,-2%,0) scale(1) rotate(0deg)}
      50%{transform:translate3d(3%,2%,0) scale(1.05) rotate(10deg)}
      100%{transform:translate3d(-3%,-2%,0) scale(1) rotate(0deg)}
    }

    .wrap{
      min-height: 100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }
    @media (max-width: 900px){
      .wrap{align-items:flex-start; padding: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom));}
    }

    .card{
      width: min(980px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .head{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .passenger{display:flex; flex-direction:column; gap:6px; min-width: 240px; max-width: 100%;}
    .passenger .label{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(10,14,24,.62);
    }
    .passenger .name{
      font-family: var(--mono);
      font-weight: 900;
      letter-spacing: .12em;
      font-size: clamp(14px, 4.4vw, 18px);
      line-height: 1.15;
      text-transform: uppercase;
      overflow-wrap:anywhere;
      word-break: break-word;
    }
    .passenger .nick{color: var(--muted); font-size: 13px; margin-top:-2px}

    .meta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      max-width:100%;
    }
    @media (max-width: 520px){
      .meta{
        width:100%;
        flex-wrap: nowrap;
        overflow:auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 2px;
      }
      .meta::-webkit-scrollbar{display:none}
    }

    .pill{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      padding: 9px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      white-space: nowrap;
      flex: 0 0 auto;
      color: rgba(10,14,24,.78);
    }
    .pill.ok{border-color: rgba(22,163,74,.20); color: rgba(22,163,74,.95); background: rgba(22,163,74,.08)}
    .pill.wait{border-color: var(--line);}

    .body{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .body{grid-template-columns: 1fr}
    }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      border-radius: 18px;
    }
    .sectionTitle b{font-size: 14px}
    .sectionTitle span{color: var(--muted); font-size: 12.5px}

    /* progress */
    .progress{
      margin-top: 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.45);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .barWrap{
      flex:1;
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(10,14,24,.06);
      overflow:hidden;
    }
    .barFill{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width .35s ease;
    }
    .progTxt{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      color: rgba(10,14,24,.70);
      white-space:nowrap;
    }

    .itinerary{display:flex; flex-direction:column; gap: 10px; margin-top: 10px}

    .stop{
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      overflow:hidden;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .stop:hover{transform: translateY(-1px); background: rgba(255,255,255,.70); border-color: rgba(10,14,24,.18)}

    .stop .left{min-width: 0}
    .stop b{font-size: 14px; display:block}
    .stop .t{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      color: rgba(10,14,24,.62);
      text-transform: uppercase;
    }
    .stop .note{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* locked: do not leak info */
    .stop.lockedStep .note{
      filter: blur(10px);
      opacity: .25;
      user-select:none;
    }
    .stop.lockedStep .titleReal{
      color: rgba(10,14,24,.55);
    }

    .openRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      flex: 0 0 auto;
    }
    .openBtnMini{
      border:1px solid rgba(10,14,24,.14);
      background: rgba(255,255,255,.75);
      color: rgba(10,14,24,.92);
      padding: 8px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
      transition: transform .08s ease, background .2s ease;
    }
    .openBtnMini:hover{transform: translateY(-1px); background: rgba(255,255,255,.95)}
    .stop.lockedStep .openRow{opacity:.45; pointer-events:none}

    /* completed */
    .stop.done{
      border-color: rgba(22,163,74,.22);
      background: linear-gradient(135deg, rgba(22,163,74,.10), rgba(255,255,255,.62));
    }
    .stop.done::after{
      content:"‚úì";
      position:absolute;
      right: 14px; bottom: 10px;
      width: 28px; height: 28px;
      border-radius: 999px;
      display:grid; place-items:center;
      border:1px solid rgba(22,163,74,.28);
      background: rgba(255,255,255,.75);
      color: rgba(22,163,74,.95);
      font-weight: 900;
    }

    .side{
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      border-radius: 22px;
      padding: 12px;
      overflow:hidden;
    }

    .miniRow{display:flex; gap: 10px; flex-wrap:wrap; margin-top: 10px}
    .linkBtn{
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      color: rgba(10,14,24,.92);
      font-weight: 900;
      font-size: 13px;
      transition: transform .08s ease, background .2s ease;
    }
    .linkBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.95)}
    .ico{font-family:var(--mono); opacity:.70}

    /* Check-in (lighter) */
    .checkin{
      border:1px solid var(--line);
      border-radius: 22px;
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(600px 220px at 80% 20%, rgba(96,165,250,.10), transparent 60%),
        rgba(255,255,255,.60);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }

    .barcode{
      border:1px solid var(--line);
      background: rgba(255,255,255,.70);
      border-radius: 18px;
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .bars{height: 54px; display:flex; gap: 2px; align-items:flex-end; opacity:.95;}
    .bar{width:3px; background: rgba(10,14,24,.80); border-radius: 2px; opacity:.9;}
    .barcodeMeta{
      margin-top: 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: rgba(10,14,24,.70);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.16em;
      text-transform: uppercase;
    }
    .scanLine{
      position:absolute; left:-20%;
      width: 140%; height: 3px; top: -30px;
      background: linear-gradient(90deg, transparent, rgba(37,99,235,.55), rgba(10,14,24,.22), rgba(96,165,250,.55), transparent);
      opacity:0;
    }
    .barcode.scanning .scanLine{opacity:1; animation: scan 1.05s cubic-bezier(.2,.8,.2,1) 1;}
    @keyframes scan{ 0%{ top:-30px } 100%{ top: 95px } }

    .stamp{
      position:absolute; right: 14px; top: 14px;
      transform: rotate(-10deg) scale(.92);
      border:2px solid rgba(22,163,74,.55);
      color: rgba(22,163,74,.95);
      background: rgba(255,255,255,.70);
      padding: 8px 10px;
      border-radius: 14px;
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 900;
      opacity:0;
      pointer-events:none;
      box-shadow: 0 14px 40px rgba(22,163,74,.08);
    }
    .checkin.checked .stamp{opacity:1; animation: pop .22s ease-out 1;}
    @keyframes pop{ 0%{ transform: rotate(-10deg) scale(.7); opacity:.2} 100%{ transform: rotate(-10deg) scale(.92); opacity:1} }

    .bigBtn{
      width: 100%;
      margin-top: 10px;
      border: none;
      cursor:pointer;
      padding: 14px 14px;
      border-radius: 18px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: #ffffff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 18px 60px rgba(37,99,235,.18);
      transition: transform .08s ease, filter .2s ease;
    }
    .bigBtn:hover{transform: translateY(-1px); filter: brightness(1.03)}
    .bigBtn:disabled{opacity:.60; cursor:default; transform:none}

    .smallBtn{
      width:100%;
      margin-top: 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.80);
      color: rgba(10,14,24,.92);
      padding: 11px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      transition: transform .08s ease, background .2s ease;
    }
    .smallBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.95)}

    /* HUB */
    .hub{padding: 16px}
    .hubTitle{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px}
    .hubTitle h1{margin:0; font-size:18px}
    .hubTitle p{margin:0; color:var(--muted); font-size:13px}
    .gridHub{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    @media (max-width: 900px){ .gridHub{grid-template-columns: 1fr} }

    .personCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      border-radius: 22px;
      padding: 12px;
      display:flex; flex-direction:column; gap: 10px;
    }
    .personCard .top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .personCard .nm{font-weight: 950; font-size: 14px; line-height: 1.2}
    .personCard .id{font-family: var(--mono); font-size: 11px; letter-spacing:.14em; color: rgba(10,14,24,.70); text-transform: uppercase}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap}
    .ghostBtn{
      flex:1 1 auto;
      border:1px solid var(--line);
      background: rgba(255,255,255,.80);
      color: rgba(10,14,24,.92);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
    }
    .openBtn{
      flex:1 1 auto;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#ffffff;
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 950;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%; transform: translateX(-50%);
      bottom: 14px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.82);
      color: rgba(10,14,24,.85);
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 30;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px)}

    /* Easter egg modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(10,14,24,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modal{
      width: min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 22px;
      background: rgba(255,255,255,.88);
      box-shadow: 0 30px 120px rgba(16,24,40,.25);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 14px;
    }
    .modal h3{margin:0 0 8px; font-size: 16px; color: rgba(10,14,24,.92)}
    .modal p{margin:0; color: rgba(10,14,24,.76); line-height:1.35}
    .modal .cta{
      margin-top: 12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.90);
      color: rgba(10,14,24,.92);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 950;
    }
    .modal button.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#ffffff;
    }

    /* ===== Reveal minigame (slider) ===== */
    .revealOverlay{
      position:absolute; inset:0;
      background:
        radial-gradient(520px 180px at 20% 10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(520px 180px at 80% 20%, rgba(96,165,250,.10), transparent 60%),
        rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px;
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid var(--line);
    }
    .revealOverlay .hintTxt{
      min-width: 0;
      color: rgba(10,14,24,.72);
      font-size: 13px;
      line-height: 1.25;
    }
    .revealOverlay .hintTxt b{color: rgba(10,14,24,.92)}
    .slider{
      flex: 0 0 180px;
      width: 180px;
      height: 44px;
      border-radius: 999px;
      border:1px solid rgba(10,14,24,.14);
      background: rgba(255,255,255,.85);
      position:relative;
      overflow:hidden;
      user-select:none;
      touch-action:none;
    }
    .sliderFill{
      position:absolute; inset:0;
      width: 0%;
      background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(96,165,250,.18));
      transition: width .08s linear;
    }
    .sliderLabel{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(10,14,24,.55);
      pointer-events:none;
    }
    .thumb{
      position:absolute;
      top: 4px; left: 4px;
      width: 36px; height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 26px rgba(37,99,235,.18);
      display:grid; place-items:center;
      color: #fff;
      font-weight: 950;
      cursor: grab;
      touch-action:none;
    }
    .thumb:active{cursor:grabbing}
    .sliderDone .sliderLabel{color: rgba(22,163,74,.85)}
  </style>
</head>

<body>
  <div class="mesh" aria-hidden="true">
    <div class="blob" style="left:-6%; top:-8%"></div>
    <div class="blob"></div>
    <div class="blob"></div>
  </div>

  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>üéÅ Prenda desbloqueada</h3>
      <p id="eggText"></p>
      <div class="cta">
        <button id="closeEgg">Fechar</button>
        <button class="primary" id="shareEgg">Partilhar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== DADOS =====
    const PASSENGERS = [
      { id:"belinha-oliveira", title:"MS", first:"Belinha", last:"Oliveira", nick:"" },
      { id:"candido-srx-xavier", title:"MR", first:"Candido", last:"Xavier", nick:"Sr.X" },
      { id:"pedrinho-animalaria-oliveira", title:"MR", first:"Pedrinho", last:"Oliveira", nick:"Animal√°ria" },
      { id:"maria-barriguitas-oliveira", title:"MS", first:"Maria", last:"Oliveira", nick:"Barriguitas" },
      { id:"miguel-roadrunner-santos", title:"MR", first:"Miguel", last:"Santos", nick:"RoadRunner" },
      { id:"joana-pipa-luis", title:"MS", first:"Joana", last:"Lu√≠s", nick:"Pipa" },
    ];

    const TRIP = {
      dateLabel: "data a combinar",
      flight: "QUAKE1755",
      gate: "BEL√âM",
      from: "LIS",
      to: "BLM",
      links: {
        meet:  "https://www.google.com/maps/search/?api=1&query=Bel%C3%A9m%20Lisboa",
        food:  "https://www.google.com/maps/search/?api=1&query=Bel%C3%A9m%20Lisboa",
        museum:"https://www.google.com/maps/search/?api=1&query=Quake%20Museu%20do%20Terramoto%20de%20Lisboa",
        nata:  "https://www.google.com/maps/search/?api=1&query=Past%C3%A9is%20de%20Bel%C3%A9m",
        garden:"https://www.google.com/maps/search/?api=1&query=Jardim%20da%20Pra%C3%A7a%20do%20Imp%C3%A9rio%20Bel%C3%A9m",
        tower: "https://www.google.com/maps/search/?api=1&query=Torre%20de%20Bel%C3%A9m",
        spritz:"https://www.google.com/maps/search/?api=1&query=bar%20Bel%C3%A9m%20Lisboa%20spritz"
      },
      itinerary: [
        { key:"meet",   time:"11:00", title:"Encontro",               note:"Ponto de encontro em Bel√©m",                    urlKey:"meet" },
        { key:"nata",   time:"11:15", title:"Pastel de nata",         note:"Past√©is de Bel√©m",              urlKey:"nata" },
        { key:"museum", time:"12:00", title:"Museu do Terramoto",     note:"Entrada / experi√™ncia",                        urlKey:"museum" },
        { key:"food",   time:"14:00", title:"P√£o P√£o Queijo Queijo",         note:"Encher o bandulho",              urlKey:"food" },
        // ‚úÖ NOVO PASSO (podes mudar texto/hora)
        { key:"garden", time:"16:30", title:"Passeio & foto",         note:"Jardim da Pra√ßa do Imp√©rio (foto de fam√≠lia)", urlKey:"garden" },
        { key:"tower",  time:"17:00", title:"P√¥r-do-sol",             note:"Torre de Bel√©m",                     urlKey:"tower" },
        { key:"spritz", time:"17:30", title:"Cocktail",                 note:"Bebidas",                           urlKey:"spritz" },
      ],
      easterEgg: "Prenda de natal, voc√™s aturarem-me o dia todoüòà. Adoro-vos"
    };
    // =================

    const $ = (s)=>document.querySelector(s);
    const app = $("#app");
    const toast = $("#toast");
    const modalBack = $("#modalBack");
    const eggText = $("#eggText");
    const closeEgg = $("#closeEgg");
    const shareEgg = $("#shareEgg");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
    }

    function airlineName(p){
      const last = (p.last || "").toUpperCase();
      const first = (p.first || "").toUpperCase();
      const title = (p.title || "").toUpperCase();
      return `${title} ${last}/${first}`.trim();
    }
    function nickLine(p){ return p.nick ? `‚Äú${p.nick}‚Äù` : ""; }

    function makeBars(seed){
      let x = seed;
      const rand = ()=> (x = (x*9301 + 49297) % 233280) / 233280;
      const bars = [];
      for(let i=0;i<58;i++){
        const h = 16 + Math.floor(rand()*38);
        const w = rand() < 0.28 ? 2 : 3;
        const op = 0.60 + rand()*0.40;
        bars.push({h,w,op});
      }
      return bars;
    }

    function passView(p){
      const seed = p.id.length*1337 + (p.first?.length||0)*97 + (p.last?.length||0)*31;
      const bars = makeBars(seed).map(b=>`
        <div class="bar" style="height:${b.h}px;width:${b.w}px;opacity:${b.op}"></div>
      `).join("");

      // üîí Em locked, N√ÉO mostramos o t√≠tulo real (s√≥ aparece ap√≥s reveal)
      const stops = TRIP.itinerary.map(s=>{
        const url = TRIP.links[s.urlKey];
        return `
          <div class="stop lockedStep" data-key="${s.key}" data-url="${url}"
               data-title="${escapeHtml(s.title)}" data-note="${escapeHtml(s.note)}">
            <div class="left">
              <b class="titleReal">Atividade selada</b>
              <div class="t">${s.time}</div>
              <div class="note">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            </div>

            <div class="openRow">
              <button class="openBtnMini" data-open>ABRIR</button>
            </div>

            <div class="revealOverlay" data-reveal>
              <div class="hintTxt">
                <b>Passo selado.</b><br/>
                Arrasta para revelar.
              </div>

              <div class="slider" data-slider>
                <div class="sliderFill" data-fill></div>
                <div class="sliderLabel" data-label>ARRASTA ‚Üí REVELAR</div>
                <div class="thumb" data-thumb>‚Ä∫</div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="head">
          <div class="passenger">
            <div class="label">Passenger</div>
            <div class="name">${airlineName(p)}</div>
            <div class="nick">${nickLine(p)}</div>
          </div>

          <div class="meta">
            <div class="pill wait" id="statusPill">READY</div>
            <div class="pill">FLIGHT ${TRIP.flight}</div>
            <div class="pill">${TRIP.from}‚Üí${TRIP.to}</div>
            <div class="pill">DATE ${TRIP.dateLabel}</div>
          </div>
        </div>

        <div class="body">
          <div>
            <div class="checkin" id="checkinBox">
              <div class="stamp">CHECKED-IN</div>

              <div class="barcode" id="barcode">
                <div class="scanLine"></div>
                <div class="bars" aria-hidden="true">${bars}</div>
                <div class="barcodeMeta">
                  <span>${TRIP.flight} ‚Ä¢ ${TRIP.gate}</span>
                  <span>${p.id.toUpperCase()}</span>
                </div>
              </div>

              <button class="bigBtn" id="btnCheckIn">CHECK-IN </button>
            </div>

            <div style="height:12px"></div>

            <div class="sectionTitle">
              <b>üó∫Ô∏è Roteiro</b>
              <span>revela e abre cada passo</span>
            </div>

            <div class="progress">
              <div class="barWrap"><div class="barFill" id="barFill"></div></div>
              <div class="progTxt" id="progTxt">0/${TRIP.itinerary.length}</div>
            </div>

            <div class="itinerary" id="itinerary">${stops}</div>
          </div>
        </div>
      `;
    }

    function hubView(){
      const base = location.origin + location.pathname;
      const cards = PASSENGERS.map(p=>{
        const link = `${base}?p=${encodeURIComponent(p.id)}`;
        const pretty = `${p.first} ${p.nick ? `‚Äú${p.nick}‚Äù ` : ""}${p.last}`.trim();
        return `
          <div class="personCard">
            <div class="top">
              <div>
                <div class="nm">${pretty}</div>
                <div class="id">${airlineName(p)}</div>
              </div>
              <div class="pill" style="opacity:.9">${p.id}</div>
            </div>
            <div class="rowBtns">
              <button class="ghostBtn" data-copy="${link}">Copiar link</button>
              <button class="openBtn" data-open="${link}">Abrir</button>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="hub">
          <div class="hubTitle">
            <div>
              <h1>üì® Links personalizados (um por pessoa)</h1>
              <p>Abre um, copia o link e envia. Cada link vai direto para o bilhete dessa pessoa.</p>
            </div>
            <div class="pill">DATE ${TRIP.dateLabel}</div>
          </div>

          <div class="gridHub">${cards}</div>
        </div>
      `;
    }

    function getPassengerFromQuery(){
      const sp = new URLSearchParams(location.search);
      const id = sp.get("p");
      if(!id) return null;
      return PASSENGERS.find(x => x.id === id) || null;
    }

    function updateProgress(){
      const total = TRIP.itinerary.length;
      const done = app.querySelectorAll(".stop.done").length;
      const pct = Math.round((done/total)*100);
      $("#barFill").style.width = pct + "%";
      $("#progTxt").textContent = `${done}/${total}`;

      if(done === total){
        eggText.textContent = TRIP.easterEgg;
        modalBack.style.display = "flex";
        showToast("Miss√£o completa ‚úÖ");
      }
    }

    function closeModal(){ modalBack.style.display = "none"; }
    closeEgg.addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

    shareEgg.addEventListener("click", async ()=>{
      const text = TRIP.easterEgg;
      try{
        if(navigator.share){
          await navigator.share({ title:"Prenda desbloqueada", text });
        }else{
          await navigator.clipboard.writeText(text);
          showToast("Frase copiada ‚úÖ");
        }
      }catch(e){}
    });

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function revealStop(stop){
      stop.classList.remove("lockedStep");

      // Inject real title/note now (no leak before reveal)
      const title = stop.dataset.title || "Atividade";
      const note  = stop.dataset.note  || "";
      const titleEl = stop.querySelector(".titleReal");
      const noteEl  = stop.querySelector(".note");
      if(titleEl) titleEl.textContent = title;
      if(noteEl)  noteEl.textContent  = note;

      const overlay = stop.querySelector("[data-reveal]");
      if(overlay) overlay.remove();

      showToast("Passo revelado ‚úÖ");
      try{ navigator.vibrate?.(10); }catch(e){}
    }

    function wireSliders({ startedRef }){
      // Slider minigame per step
      app.querySelectorAll("[data-slider]").forEach(slider=>{
        const stop  = slider.closest(".stop");
        const thumb = slider.querySelector("[data-thumb]");
        const fill  = slider.querySelector("[data-fill]");
        const label = slider.querySelector("[data-label]");

        let dragging = false;
        let startX = 0;
        let startLeft = 0;

        function setPos(px){
          const rect = slider.getBoundingClientRect();
          const min = 4;
          const max = rect.width - 4 - thumb.offsetWidth;
          const clamped = Math.max(min, Math.min(max, px));
          thumb.style.left = clamped + "px";

          const pct = ((clamped - min) / (max - min)) * 100;
          fill.style.width = (pct) + "%";

          if(pct >= 96){
            slider.classList.add("sliderDone");
            if(label) label.textContent = "REVELADO ‚úÖ";
            revealStop(stop);
          }
        }

        thumb.addEventListener("pointerdown", (e)=>{
          if(!startedRef.started){
            showToast("Primeiro faz CHECK-IN üòÑ");
            return;
          }
          if(!stop.classList.contains("lockedStep")) return;

          dragging = true;
          thumb.setPointerCapture(e.pointerId);
          const rectThumb = thumb.getBoundingClientRect();
          startX = e.clientX;
          startLeft = rectThumb.left - slider.getBoundingClientRect().left;
        });

        thumb.addEventListener("pointermove", (e)=>{
          if(!dragging) return;
          const dx = e.clientX - startX;
          setPos(startLeft + dx);
        });

        thumb.addEventListener("pointerup", (e)=>{
          if(!dragging) return;
          dragging = false;
          // If not completed, snap back
          if(stop.classList.contains("lockedStep")){
            thumb.style.left = "4px";
            fill.style.width = "0%";
          }
        });
      });
    }

    function wirePass(p){
      const startedRef = { started: false };

      const btn = $("#btnCheckIn");
      const barcode = $("#barcode");
      const box = $("#checkinBox");
      const pill = $("#statusPill");

      btn.addEventListener("click", ()=>{
        if(startedRef.started) return;

        barcode.classList.remove("scanning");
        void barcode.offsetWidth;
        barcode.classList.add("scanning");

        pill.textContent = "SCANNING";
        pill.classList.remove("wait");

        setTimeout(()=>{
          startedRef.started = true;
          box.classList.add("checked");

          pill.textContent = "CHECKED-IN";
          pill.classList.add("ok");

          btn.disabled = true;
          btn.textContent = "CHECK-IN FEITO ‚úÖ";

          try{ navigator.vibrate?.(18); }catch(e){}
          showToast("Miss√£o iniciada. Agora revela os passos üòâ");
        }, 850);
      });

      // Open map only when revealed (and only one open control exists now)
      app.querySelectorAll("[data-open]").forEach(btnOpen=>{
        btnOpen.addEventListener("click", (e)=>{
          e.stopPropagation();
          const stop = btnOpen.closest(".stop");

          if(!startedRef.started){
            showToast("Primeiro faz CHECK-IN üòÑ");
            return;
          }
          if(stop.classList.contains("lockedStep")){
            showToast("Revela este passo primeiro üòâ");
            return;
          }

          stop.classList.add("done");
          updateProgress();

          const url = stop.getAttribute("data-url");
          window.open(url, "_blank", "noopener");
        });
      });

      // Copy link
const copyBtn = $("#btnCopyLink");
if (copyBtn) {
  copyBtn.addEventListener("click", async ()=>{
    const base = location.origin + location.pathname;
    const link = `${base}?p=${encodeURIComponent(p.id)}`;
    try{
      await navigator.clipboard.writeText(link);
      showToast("Link copiado ‚úÖ");
    }catch(e){
      showToast("N√£o deu para copiar (browser).");
    }
  });
}

      wireSliders({ startedRef });
      updateProgress();
    }

    function wireHub(){
      app.querySelectorAll("[data-copy]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const link = btn.getAttribute("data-copy");
          try{ await navigator.clipboard.writeText(link); showToast("Link copiado ‚úÖ"); }
          catch(e){ showToast("N√£o deu para copiar (browser)."); }
        });
      });
      app.querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const link = btn.getAttribute("data-open");
          window.open(link, "_blank", "noopener");
        });
      });
    }

    // Render
    const passenger = getPassengerFromQuery();
    if(passenger){
      app.innerHTML = passView(passenger);
      wirePass(passenger);
    }else{
      app.innerHTML = hubView();
      wireHub();
    }
  </script>
</body>
</html>
